---
- name: Add Flux bash completions to login profile on all server nodes
  ansible.builtin.lineinfile:
    line: ". <(flux completion bash)"
    path: /etc/profile
    state: present
  when: flux_vars.add_bash_autocompletions

# As per https://fluxcd.io/flux/installation, flux bootstrap is indempotent. Hence, it's safe to run this just using Ansible's command module
- name: Bootstrap the Flux Git repository
  ansible.builtin.command:
    cmd: flux bootstrap github --owner={{ flux_vars.bootstrap.owner }} --repository={{ flux_vars.bootstrap.repository }} --branch={{ flux_vars.bootstrap.branch }} --path={{ flux_vars.bootstrap.path }} --cluster-domain={{ flux_vars.cluster_domain }} --private=false --personal=false
  register: script_result
  changed_when: script_result.rc == 0
