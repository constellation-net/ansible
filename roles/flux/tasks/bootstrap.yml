---
- name: Add Flux bash completions to login profile on all server nodes
  ansible.builtin.lineinfile:
    line: ". <(flux completion bash)"
    path: /etc/profile
    state: present
  when: add_bash_autocompletions | bool == true

# As per https://fluxcd.io/flux/installation, flux bootstrap is indempotent. Hence, it's safe to run this just using Ansible's command module
- name: Bootstrap the Flux Git repository
  ansible.builtin.command:
    cmd: flux bootstrap git --url=ssh://git@{{ git.host }}/{{ git.owner }}/{{ git.repository }} --branch={{ git.branch }} --private-key-file={{ git.private_key.path }} --password={{ git.private_key.password }} --path={{ git.path }} --cluster-domain={{ cluster_domain }}