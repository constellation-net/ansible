---
- name: Create master config
  ansible.builtin.template:
    src: templates/config.yml.j2
    dest: /etc/rancher/k3s/config.yaml
    force: true
    owner: root
    group: root
    mode: "0644" # U:RW, G:R, O:R

- name: Add kubeconfig to profile exports
  ansible.builtin.lineinfile:
    line: export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
    path: /etc/profile
    state: present

- name: Fetch the token that was generated by k3s
  ansible.builtin.slurp:
    src: /var/lib/rancher/k3s/server/node-token
  register: token_file

# Other hosts can read these facts by directly fetching the master node's variables
# E.g. hostvars[groups['master'][0]]['master_token']
# Or: hostvars[groups['master'][0]]['master_ip']
- name: Set master node info as facts
  set_fact:
    master_token: "{{ token_file['content'] | b64decode }}"
    master_ip: "{{ ansible_host }}"
